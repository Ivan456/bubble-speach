"use strict";var _createClass=function(){function a(c,d){for(var g,f=0;f<d.length;f++)g=d[f],g.enumerable=g.enumerable||!1,g.configurable=!0,"value"in g&&(g.writable=!0),Object.defineProperty(c,g.key,g)}return function(c,d,f){return d&&a(c.prototype,d),f&&a(c,f),c}}();function _classCallCheck(a,c){if(!(a instanceof c))throw new TypeError("Cannot call a class as a function")}var BubbleCreator=function(){var a=function(){function f(g,j){_classCallCheck(this,f),this.canvas=g,this.hasControls=!1,this.x=j.x,this.y=j.y,this.radius=j.radius,this.color=j.color,this.pointer={},this.hidden=j.hidden||!0,this.innerText={},this.group={}}return _createClass(f,[{key:"setBubble",value:function(j){this.bubble=j}},{key:"create",value:function(){var j=this,l={radius:this.radius,fill:this.color,left:this.x,top:this.y,hasControls:this.hasControls,hasBorders:this.hasControls};this.pointer=new fabric.Circle(l),this.pointer.on("moving",function(m){j.moving(m)})}},{key:"update",value:function(){var j={left:this.x,top:this.y};this.pointer.set(j),!1===this.hidden&&(this.hide(),this.show())}},{key:"show",value:function(){this.hidden&&(this.canvas.add(this.pointer),this.hidden=!1)}},{key:"setVisible",value:function(j){this.pointer.visible=j}},{key:"hide",value:function(){this.canvas.remove(this.pointer),this.hidden=!0}},{key:"moving",value:function(j){this.x=j.e.offsetX,this.y=j.e.offsetY,this.bubble.update()}}]),f}(),c=function(){function f(g,j,l){_classCallCheck(this,f),this.canvas=g,this.pointer=l,this.x=j.x,this.y=j.y,this.w=j.w,this.h=j.h,this.radius=Math.min(j.h,j.w)/5,this.fabricPathText=[],this.bubble={},this.backgroundColor=j.backgroundColor,this.lineColor=j.lineColor,this.lineWidth=j.lineWidth,this.direction,this.bordersOptions={borderColor:"red",cornerColor:"green",cornerSize:7,transparentCorners:!1}}return _createClass(f,[{key:"beginPath",value:function(){this.fabricPathText=[]}},{key:"moveTo",value:function(j,l){this.fabricPathText.push(["M",j,l])}},{key:"lineTo",value:function(j,l){this.fabricPathText.push(["L",j,l])}},{key:"quadraticCurveTo",value:function(j,l,m,n){this.fabricPathText.push(["Q",j,l,m,n])}},{key:"stroke",value:function(){this.fabricPathText.push(["z"])}},{key:"generatePath",value:function(){var t,u,v,j=this.x,l=this.y,m=this.w,n=this.h,p=this.radius,q=j+m,s=l+n;p=Math.min(n,m)/4,this.pointer.y<l||this.pointer.y>l+n?(v=0.3*m,t=Math.min(Math.max(j+p,this.pointer.x-v/2),q-p-v),u=Math.min(Math.max(j+p+v,this.pointer.x+v/2),q-p)):(v=0.3*n,t=Math.min(Math.max(l+p,this.pointer.y-v/2),s-p-v),u=Math.min(Math.max(l+p+v,this.pointer.y+v/2),s-p)),console.log("con1"+t+"con2"+u);var z;this.pointer.y<l&&(z=this.direction=2),this.pointer.y>l&&(z=this.direction=3),this.pointer.x<j&&this.pointer.y>=l&&this.pointer.y<=s&&(z=this.direction=0),this.pointer.x>j&&this.pointer.y>=l&&this.pointer.y<=s&&(z=this.direction=1),this.pointer.x>=j&&this.pointer.x<=q&&this.pointer.y>=l&&this.pointer.y<=s&&(z=-1),this.beginPath(),this.moveTo(j+p,l),2==z?(this.lineTo(t,l),this.lineTo(this.pointer.x,this.pointer.y),this.lineTo(u,l),this.lineTo(q-p,l)):this.lineTo(q-p,l),this.quadraticCurveTo(q,l,q,l+p),1==z?(this.lineTo(q,t),this.lineTo(this.pointer.x,this.pointer.y),this.lineTo(q,u),this.lineTo(q,s-p)):this.lineTo(q,s-p),this.quadraticCurveTo(q,s,q-p,s),3==z?(this.lineTo(u,s),this.lineTo(this.pointer.x,this.pointer.y),this.lineTo(t,s),this.lineTo(j+p,s)):this.lineTo(j+p,s),this.quadraticCurveTo(j,s,j,s-p),0==z?(this.lineTo(j,u),this.lineTo(this.pointer.x,this.pointer.y),this.lineTo(j,t),this.lineTo(j,l+p)):this.lineTo(j,l+p),this.quadraticCurveTo(j,l,j+p,l),this.stroke()}},{key:"setEvents",value:function(){var j=this;this.canvas.on("object:scaling",function(l){var m=l.target;!m.strokeWidthUnscaled&&m.strokeWidth&&(m.strokeWidthUnscaled=m.strokeWidth),m.strokeWidthUnscaled&&(m.strokeWidth=m.strokeWidthUnscaled/m.scaleX)}),this.bubble.on("moving",function(){j.pointer.setVisible(!1)}),this.bubble.on("rotating",function(){console.log("rotating"),j.pointer.setVisible(!1)}),this.bubble.on("scaling",function(){console.log("SCALING"),j.pointer.setVisible(!1)}),this.bubble.on("modified",function(){j.pointer.setVisible(!0)}),this.bubble.on("selected",function(l){j.scaling(l),j.pointer.show()})}},{key:"create",value:function(){this.generatePath(),this.bubble=new fabric.Path(this.fabricPathText),this.setEvents(),this.bubble.set({strokeWidth:this.lineWidth,fill:this.backgroundColor,stroke:this.lineColor,hasRotatingPoint:!1}),this.bubble.set(this.bordersOptions),this.show()}},{key:"update",value:function(){this.hide(),this.create()}},{key:"moving",value:function(j){this.x+=j.e.movementX,this.y+=j.e.movementY,this.pointer.x+=j.e.movementX,this.pointer.y+=j.e.movementY,this.pointer.update()}},{key:"scaling",value:function(){console.log("scaling");var l;if(0==this.direction){this.pointer.x=this.bubble.oCoords.tl.x-13,l=(-this.bubble.oCoords.tl.y+this.bubble.oCoords.bl.y)/(this.fabricPathText[6][2]-this.fabricPathText[11][2]),this.pointer.y=l*(this.fabricPathText[8][2]-this.fabricPathText[11][2])+this.bubble.oCoords.tl.y-13,this.h=this.bubble.oCoords.mb.y-this.bubble.oCoords.mt.y;var m=(this.fabricPathText[3][1]-this.fabricPathText[9][1])/(this.fabricPathText[3][1]-this.fabricPathText[8][1]);this.w=(this.bubble.oCoords.mr.x-this.bubble.oCoords.ml.x)*m,this.y=this.bubble.oCoords.tl.y,this.x=this.bubble.oCoords.ml.x+(this.bubble.oCoords.mr.x-this.bubble.oCoords.ml.x)*(1-m)}if(2==this.direction){var n=(this.fabricPathText[9][2]-this.fabricPathText[11][2])/(this.fabricPathText[9][2]-this.fabricPathText[2][2]);if(this.y=this.bubble.oCoords.tl.y+(1-n)*(this.bubble.oCoords.bl.y-this.bubble.oCoords.tl.y),this.fabricPathText[2][1]>this.fabricPathText[11][1]&&this.fabricPathText[2][1]<this.fabricPathText[5][1])this.pointer.y=this.bubble.oCoords.tl.y-16,l=(-this.bubble.oCoords.tl.x+this.bubble.oCoords.tr.x)/(this.fabricPathText[5][1]-this.fabricPathText[11][1]),this.pointer.x=l*(this.fabricPathText[2][1]-this.fabricPathText[11][1])+this.bubble.oCoords.tl.x-8,this.w=this.bubble.oCoords.tr.x-this.bubble.oCoords.tl.x,this.x=this.bubble.oCoords.tl.x;else if(this.fabricPathText[2][1]<this.fabricPathText[11][1]){this.pointer.y=this.bubble.oCoords.tl.y-14,this.pointer.x=this.bubble.oCoords.tl.x-13;var p=(this.fabricPathText[5][1]-this.fabricPathText[11][1])/(this.fabricPathText[5][1]-this.fabricPathText[2][1]);this.w=(this.bubble.oCoords.tr.x-this.bubble.oCoords.tl.x)*p,this.x=this.bubble.oCoords.tl.x+(this.bubble.oCoords.tr.x-this.bubble.oCoords.tl.x)*(1-p)}else if(this.fabricPathText[2][1]>this.fabricPathText[5][1]){this.pointer.y=this.bubble.oCoords.tr.y-14,this.pointer.x=this.bubble.oCoords.tr.x-5;var q=(this.fabricPathText[5][1]-this.fabricPathText[11][1])/(this.fabricPathText[2][1]-this.fabricPathText[11][1]);this.w=(this.bubble.oCoords.tr.x-this.bubble.oCoords.tl.x)*q,this.x=this.bubble.oCoords.tl.x}this.h=(this.bubble.oCoords.bl.y-this.bubble.oCoords.tl.y)*n}if(1==this.direction){this.pointer.x=this.bubble.oCoords.tr.x,l=(-this.bubble.oCoords.tl.y+this.bubble.oCoords.bl.y)/(this.fabricPathText[7][2]-this.fabricPathText[2][2]),this.pointer.y=l*(this.fabricPathText[4][2]-this.fabricPathText[2][2])+this.bubble.oCoords.tl.y-10,this.x=this.bubble.oCoords.tl.x,this.y=this.bubble.oCoords.tl.y,this.h=this.bubble.oCoords.mb.y-this.bubble.oCoords.mt.y;var s=(this.fabricPathText[2][1]-this.fabricPathText[11][1])/(this.fabricPathText[4][1]-this.fabricPathText[11][1]);this.w=(this.bubble.oCoords.mr.x-this.bubble.oCoords.ml.x)*s}if(3==this.direction){this.pointer.y=this.bubble.oCoords.bl.y;var t=(this.fabricPathText[9][2]-this.fabricPathText[11][2])/(this.fabricPathText[6][2]-this.fabricPathText[11][2]);if(this.h=(this.bubble.oCoords.bl.y-this.bubble.oCoords.tl.y)*t,this.fabricPathText[6][1]>this.fabricPathText[9][1]&&this.fabricPathText[6][1]<this.fabricPathText[4][1])l=(-this.bubble.oCoords.bl.x+this.bubble.oCoords.br.x)/(this.fabricPathText[9][1]-this.fabricPathText[4][1]),this.pointer.x=l*(-this.fabricPathText[6][1]+this.fabricPathText[9][1])+this.bubble.oCoords.tl.x-8,this.w=this.bubble.oCoords.br.x-this.bubble.oCoords.bl.x,this.x=this.bubble.oCoords.tl.x,this.y=this.bubble.oCoords.tl.y;else if(this.fabricPathText[6][1]<this.fabricPathText[9][1]){var u=(this.fabricPathText[4][1]-this.fabricPathText[9][1])/(this.fabricPathText[4][1]-this.fabricPathText[6][1]);this.w=(this.bubble.oCoords.br.x-this.bubble.oCoords.bl.x)*u,this.pointer.y=this.bubble.oCoords.bl.y-5,this.pointer.x=this.bubble.oCoords.bl.x-13,this.x=this.bubble.oCoords.bl.x+(this.bubble.oCoords.br.x-this.bubble.oCoords.bl.x)*(1-u),this.y=this.bubble.oCoords.tl.y}else if(this.fabricPathText[6][1]>this.fabricPathText[4][1]){var v=(this.fabricPathText[4][1]-this.fabricPathText[9][1])/(this.fabricPathText[6][1]-this.fabricPathText[9][1]);this.w=(this.bubble.oCoords.br.x-this.bubble.oCoords.bl.x)*v,this.pointer.y=this.bubble.oCoords.br.y-5,this.pointer.x=this.bubble.oCoords.br.x-5,this.x=this.bubble.oCoords.tl.x,this.y=this.bubble.oCoords.tl.y}}this.pointer.update()}},{key:"show",value:function(){this.canvas.add(this.bubble)}},{key:"hide",value:function(){this.canvas.remove(this.bubble)}}]),f}(),d=function(){function f(g,j,l,m){_classCallCheck(this,f),this.canvas=j,this.pointer=new a(this.canvas,m),this.bubble=new c(this.canvas,l,this.pointer),this.pointer.setBubble(this.bubble)}return _createClass(f,[{key:"init",value:function(){var j=this;this.bubble.create(),this.pointer.create(),this.canvas.on("selection:cleared",function(){j.pointer.hide()}),this.canvas.on("mouse:up",function(l){j.bubble.scaling(l),j.bubble.bubble.active?j.pointer.show():null===l.target&&j.pointer.hide()})}}]),f}();return d}();