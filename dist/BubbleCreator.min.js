var _createClass=function(){function a(c,d){for(var f,e=0;e<d.length;e++)f=d[e],f.enumerable=f.enumerable||!1,f.configurable=!0,"value"in f&&(f.writable=!0),Object.defineProperty(c,f.key,f)}return function(c,d,e){return d&&a(c.prototype,d),e&&a(c,e),c}}();function _classCallCheck(a,c){if(!(a instanceof c))throw new TypeError("Cannot call a class as a function")}var Pointer=function(){function a(c,d){_classCallCheck(this,a),this.canvas=c,this.hasControls=!1,this.x=d.x,this.y=d.y,this.radius=d.radius,this.color=d.color,this.pointer={},this.hidden=d.hidden||!0,this.innerText={},this.group={}}return _createClass(a,[{key:"setBubble",value:function(d){this.bubble=d}},{key:"create",value:function(){var d=this,e={radius:this.radius,fill:this.color,left:this.x,top:this.y,hasControls:this.hasControls,hasBorders:this.hasControls};this.pointer=new fabric.Circle(e),this.pointer.on("moving",function(f){d.moving(f)})}},{key:"update",value:function(){var d={left:this.x,top:this.y};this.pointer.set(d),!1===this.hidden&&(this.hide(),this.show())}},{key:"show",value:function(){this.hidden&&(this.canvas.add(this.pointer),this.hidden=!1)}},{key:"setVisible",value:function(d){this.pointer.visible=d}},{key:"hide",value:function(){this.canvas.remove(this.pointer),this.hidden=!0}},{key:"moving",value:function(d){this.x=d.e.clientX,this.y=d.e.clientY,this.bubble.update()}}]),a}(),Bubble=function(){function a(c,d,e){_classCallCheck(this,a),this.canvas=c,this.pointer=e,this.x=d.x,this.y=d.y,this.w=d.w,this.h=d.h,this.radius=Math.min(d.h,d.w)/5,this.fabricPathText=[],this.bubble={},this.backgroundColor=d.backgroundColor,this.lineColor=d.lineColor,this.lineWidth=d.lineWidth,this.direction,this.bordersOptions={borderColor:"red",cornerColor:"green",cornerSize:7,transparentCorners:!1}}return _createClass(a,[{key:"beginPath",value:function(){this.fabricPathText=[]}},{key:"moveTo",value:function(d,e){this.fabricPathText.push(["M",d,e])}},{key:"lineTo",value:function(d,e){this.fabricPathText.push(["L",d,e])}},{key:"quadraticCurveTo",value:function(d,e,f,g){this.fabricPathText.push(["Q",d,e,f,g])}},{key:"stroke",value:function(){this.fabricPathText.push(["z"])}},{key:"generatePath",value:function(){var n,o,p,d=this.x,e=this.y,f=this.w,g=this.h,j=this.radius,l=d+f,m=e+g;j=Math.min(g,f)/4,console.log("generatePath"),this.pointer.y<e||this.pointer.y>e+g?(p=0.2*f,n=Math.min(Math.max(d+j,this.pointer.x-p/2),l-j-p),o=Math.min(Math.max(d+j+p,this.pointer.x+p/2),l-j)):(p=0.3*g,n=Math.min(Math.max(e+j,this.pointer.y-p/2),m-j-p),o=Math.min(Math.max(e+j+p,this.pointer.y+p/2),m-j));var q;this.pointer.y<e&&(q=this.direction=2),this.pointer.y>e&&(q=this.direction=3),this.pointer.x<d&&this.pointer.y>=e&&this.pointer.y<=m&&(q=this.direction=0),this.pointer.x>d&&this.pointer.y>=e&&this.pointer.y<=m&&(q=this.direction=1),this.pointer.x>=d&&this.pointer.x<=l&&this.pointer.y>=e&&this.pointer.y<=m&&(q=-1),this.beginPath(),this.moveTo(d+j,e),2==q?(this.lineTo(n,e),this.lineTo(this.pointer.x,this.pointer.y),this.lineTo(o,e),this.lineTo(l-j,e)):this.lineTo(l-j,e),this.quadraticCurveTo(l,e,l,e+j),1==q?(this.lineTo(l,n),this.lineTo(this.pointer.x,this.pointer.y),this.lineTo(l,o),this.lineTo(l,m-j)):this.lineTo(l,m-j),this.quadraticCurveTo(l,m,l-j,m),3==q?(this.lineTo(o,m),this.lineTo(this.pointer.x,this.pointer.y),this.lineTo(n,m),this.lineTo(d+j,m)):this.lineTo(d+j,m),this.quadraticCurveTo(d,m,d,m-j),0==q?(this.lineTo(d,o),this.lineTo(this.pointer.x,this.pointer.y),this.lineTo(d,n),this.lineTo(d,e+j)):this.lineTo(d,e+j),this.quadraticCurveTo(d,e,d+j,e),this.stroke()}},{key:"setEvents",value:function(){var d=this;this.bubble.on("moving",function(){d.pointer.setVisible(!1)}),this.bubble.on("rotating",function(){console.log("rotating"),d.pointer.setVisible(!1)}),this.bubble.on("scaling",function(){console.log("SCALING"),d.pointer.setVisible(!1)}),this.bubble.on("modified",function(){d.pointer.setVisible(!0)}),this.bubble.on("selected",function(e){d.scaling(e),d.pointer.show()})}},{key:"create",value:function(){this.generatePath(),this.bubble=new fabric.Path(this.fabricPathText),this.setEvents(),this.bubble.set({strokeWidth:this.lineWidth,fill:this.backgroundColor,stroke:this.lineColor,hasRotatingPoint:!1}),this.bubble.set(this.bordersOptions),this.show()}},{key:"update",value:function(){this.hide(),this.create()}},{key:"moving",value:function(d){this.x+=d.e.movementX,this.y+=d.e.movementY,this.pointer.x+=d.e.movementX,this.pointer.y+=d.e.movementY,this.pointer.update()}},{key:"scaling",value:function(){console.log("scaling");var e;if(0==this.direction){this.pointer.x=this.bubble.oCoords.tl.x-13,e=(-this.bubble.oCoords.tl.y+this.bubble.oCoords.bl.y)/(this.fabricPathText[6][2]-this.fabricPathText[11][2]),this.pointer.y=e*(this.fabricPathText[8][2]-this.fabricPathText[11][2])+this.bubble.oCoords.tl.y-13,this.h=this.bubble.oCoords.mb.y-this.bubble.oCoords.mt.y;var f=(this.fabricPathText[3][1]-this.fabricPathText[9][1])/(this.fabricPathText[3][1]-this.fabricPathText[8][1]);this.w=(this.bubble.oCoords.mr.x-this.bubble.oCoords.ml.x)*f,this.y=this.bubble.oCoords.tl.y,this.x=this.bubble.oCoords.ml.x+(this.bubble.oCoords.mr.x-this.bubble.oCoords.ml.x)*(1-f)}if(2==this.direction){var g=(this.fabricPathText[9][2]-this.fabricPathText[11][2])/(this.fabricPathText[9][2]-this.fabricPathText[2][2]);if(this.y=this.bubble.oCoords.tl.y+(1-g)*(this.bubble.oCoords.bl.y-this.bubble.oCoords.tl.y),this.fabricPathText[2][1]>this.fabricPathText[11][1]&&this.fabricPathText[2][1]<this.fabricPathText[5][1])this.pointer.y=this.bubble.oCoords.tl.y-16,e=(-this.bubble.oCoords.tl.x+this.bubble.oCoords.tr.x)/(this.fabricPathText[5][1]-this.fabricPathText[11][1]),this.pointer.x=e*(this.fabricPathText[2][1]-this.fabricPathText[11][1])+this.bubble.oCoords.tl.x-8,this.w=this.bubble.oCoords.tr.x-this.bubble.oCoords.tl.x,this.x=this.bubble.oCoords.tl.x;else if(this.fabricPathText[2][1]<this.fabricPathText[11][1]){this.pointer.y=this.bubble.oCoords.tl.y-14,this.pointer.x=this.bubble.oCoords.tl.x-13;var j=(this.fabricPathText[5][1]-this.fabricPathText[11][1])/(this.fabricPathText[5][1]-this.fabricPathText[2][1]);this.w=(this.bubble.oCoords.tr.x-this.bubble.oCoords.tl.x)*j,this.x=this.bubble.oCoords.tl.x+(this.bubble.oCoords.tr.x-this.bubble.oCoords.tl.x)*(1-j)}else if(this.fabricPathText[2][1]>this.fabricPathText[5][1]){this.pointer.y=this.bubble.oCoords.tr.y-14,this.pointer.x=this.bubble.oCoords.tr.x-5;var l=(this.fabricPathText[5][1]-this.fabricPathText[11][1])/(this.fabricPathText[2][1]-this.fabricPathText[11][1]);this.w=(this.bubble.oCoords.tr.x-this.bubble.oCoords.tl.x)*l,this.x=this.bubble.oCoords.tl.x}this.h=(this.bubble.oCoords.bl.y-this.bubble.oCoords.tl.y)*g}if(1==this.direction){this.pointer.x=this.bubble.oCoords.tr.x,e=(-this.bubble.oCoords.tl.y+this.bubble.oCoords.bl.y)/(this.fabricPathText[7][2]-this.fabricPathText[2][2]),this.pointer.y=e*(this.fabricPathText[4][2]-this.fabricPathText[2][2])+this.bubble.oCoords.tl.y-10,this.x=this.bubble.oCoords.tl.x,this.y=this.bubble.oCoords.tl.y,this.h=this.bubble.oCoords.mb.y-this.bubble.oCoords.mt.y;var m=(this.fabricPathText[2][1]-this.fabricPathText[11][1])/(this.fabricPathText[4][1]-this.fabricPathText[11][1]);this.w=(this.bubble.oCoords.mr.x-this.bubble.oCoords.ml.x)*m}if(3==this.direction){this.pointer.y=this.bubble.oCoords.bl.y;var n=(this.fabricPathText[9][2]-this.fabricPathText[11][2])/(this.fabricPathText[6][2]-this.fabricPathText[11][2]);if(this.h=(this.bubble.oCoords.bl.y-this.bubble.oCoords.tl.y)*n,this.fabricPathText[6][1]>this.fabricPathText[9][1]&&this.fabricPathText[6][1]<this.fabricPathText[4][1])e=(-this.bubble.oCoords.bl.x+this.bubble.oCoords.br.x)/(this.fabricPathText[9][1]-this.fabricPathText[4][1]),this.pointer.x=e*(-this.fabricPathText[6][1]+this.fabricPathText[9][1])+this.bubble.oCoords.tl.x-8,this.w=this.bubble.oCoords.br.x-this.bubble.oCoords.bl.x,this.x=this.bubble.oCoords.tl.x,this.y=this.bubble.oCoords.tl.y;else if(this.fabricPathText[6][1]<this.fabricPathText[9][1]){var o=(this.fabricPathText[4][1]-this.fabricPathText[9][1])/(this.fabricPathText[4][1]-this.fabricPathText[6][1]);this.w=(this.bubble.oCoords.br.x-this.bubble.oCoords.bl.x)*o,this.pointer.y=this.bubble.oCoords.bl.y-5,this.pointer.x=this.bubble.oCoords.bl.x-13,this.x=this.bubble.oCoords.bl.x+(this.bubble.oCoords.br.x-this.bubble.oCoords.bl.x)*(1-o),this.y=this.bubble.oCoords.tl.y}else if(this.fabricPathText[6][1]>this.fabricPathText[4][1]){var p=(this.fabricPathText[4][1]-this.fabricPathText[9][1])/(this.fabricPathText[6][1]-this.fabricPathText[9][1]);this.w=(this.bubble.oCoords.br.x-this.bubble.oCoords.bl.x)*p,this.pointer.y=this.bubble.oCoords.br.y-5,this.pointer.x=this.bubble.oCoords.br.x-5,this.x=this.bubble.oCoords.tl.x,this.y=this.bubble.oCoords.tl.y}}this.pointer.update()}},{key:"show",value:function(){this.canvas.add(this.bubble)}},{key:"hide",value:function(){this.canvas.remove(this.bubble)}}]),a}(),BubbleCreator=function(){function a(c,d,e,f){_classCallCheck(this,a),this.canvas=d,this.pointer=new Pointer(this.canvas,f),this.bubble=new Bubble(this.canvas,e,this.pointer),this.pointer.setBubble(this.bubble)}return _createClass(a,[{key:"init",value:function(){var d=this;this.bubble.create(),this.pointer.create(),this.canvas.on("selection:cleared",function(){d.pointer.hide()}),this.canvas.on("mouse:up",function(e){d.bubble.scaling(e),d.bubble.bubble.active?d.pointer.show():null===e.target&&d.pointer.hide()})}}]),a}();