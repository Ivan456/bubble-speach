"use strict";var _createClass=function(){function t(t,i){for(var s=0;s<i.length;s++){var e=i[s];e.enumerable=e.enumerable||!1,e.configurable=!0,"value"in e&&(e.writable=!0),Object.defineProperty(t,e.key,e)}}return function(i,s,e){return s&&t(i.prototype,s),e&&t(i,e),i}}();function _classCallCheck(t,i){if(!(t instanceof i))throw new TypeError("Cannot call a class as a function")}var Bubble=function(){var t;(t=fabric).BubblePath=t.util.createClass(t.Path,{type:"BubblePath",initialize:function(t){this.callSuper("initialize",t)}}),t.BubblePath.fromObject=function(i,s){var h=i.bubbleOptions,o=i.pointerOptions;new e(t,canvas,h,o),canvas.renderAll()};var i=function(){function t(i,s){_classCallCheck(this,t),this.id="BubblePointer"+Date.now(),this.canvas=i,this.hasControls=!1,this.x=s.x,this.y=s.y,this.radius=s.radius,this.color=s.color,this.pointer={},this.hidden=s.hidden||!0,this.innerText={},this.group={}}return _createClass(t,[{key:"setBubble",value:function(t){this.bubble=t}},{key:"create",value:function(){var t=this,i={radius:this.radius,fill:this.color,left:this.x,top:this.y,hasControls:this.hasControls,hasBorders:this.hasControls};this.pointer=new fabric.Circle(i),this.pointer.on("moving",function(i){t.moving(i)})}},{key:"update",value:function(){var t={left:this.x,top:this.y};this.pointer.set(t),!1===this.hidden&&(this.hide(),this.show())}},{key:"show",value:function(){this.hidden&&(this.canvas.add(this.pointer),this.hidden=!1)}},{key:"setVisible",value:function(t){this.pointer.visible=t}},{key:"hide",value:function(){this.canvas.remove(this.pointer),this.hidden=!0}},{key:"moving",value:function(t){this.x=t.e.offsetX,this.y=t.e.offsetY,this.bubble.update()}}]),t}(),s=function(){function t(i,s,e,h){_classCallCheck(this,t),this.id="BubblePath"+Date.now(),this.canvas=i,this.pointer=e,this.x=s.x,this.y=s.y,this.w=s.w,this.h=s.h,this.radius=Math.min(s.h,s.w)/5,this.fabricPathText=[],this.bubble={},this.backgroundColor=s.backgroundColor,this.lineColor=s.lineColor,this.lineWidth=s.lineWidth,this.direction,this.bordersOptions={borderColor:"red",cornerColor:"green",cornerSize:7,transparentCorners:!1},this.extendFabricPathBubble(h)}return _createClass(t,[{key:"extendFabricPathBubble",value:function(t){var i=this;t[i.id]=t.util.createClass(t.Path,{type:i.id,initialize:function(t){this.callSuper("initialize",t)},toObject:function(){return i.pointer.hide(),{type:"BubblePath",bubbleOptions:{x:i.x,y:i.y,w:i.w,h:i.h,lineWidth:i.lineWidth,lineColor:i.lineColor,backgroundColor:i.backgroundColor},pointerOptions:{x:i.pointer.x,y:i.pointer.y,radius:i.pointer.radius,color:i.pointer.color}}}}),t[i.id].async=!0}},{key:"beginPath",value:function(){this.fabricPathText=[]}},{key:"moveTo",value:function(t,i){this.fabricPathText.push(["M",t,i])}},{key:"lineTo",value:function(t,i){this.fabricPathText.push(["L",t,i])}},{key:"quadraticCurveTo",value:function(t,i,s,e){this.fabricPathText.push(["Q",t,i,s,e])}},{key:"stroke",value:function(){this.fabricPathText.push(["z"])}},{key:"generatePath",value:function(){var t=this.x,i=this.y,s=this.w,e=this.h,h=this.radius,o=t+s,b=i+e,r=void 0,a=void 0,n=void 0;h=Math.min(e,s)/4,this.pointer.y<i||this.pointer.y>i+e?(n=.3*s,r=Math.min(Math.max(t+h,this.pointer.x-n/2),o-h-n),a=Math.min(Math.max(t+h+n,this.pointer.x+n/2),o-h)):(n=.3*e,r=Math.min(Math.max(i+h,this.pointer.y-n/2),b-h-n),a=Math.min(Math.max(i+h+n,this.pointer.y+n/2),b-h));var l=void 0;this.pointer.y<i&&(l=this.direction=2),this.pointer.y>i&&(l=this.direction=3),this.pointer.x<t&&this.pointer.y>=i&&this.pointer.y<=b&&(l=this.direction=0),this.pointer.x>t&&this.pointer.y>=i&&this.pointer.y<=b&&(l=this.direction=1),this.pointer.x>=t&&this.pointer.x<=o&&this.pointer.y>=i&&this.pointer.y<=b&&(l=-1),this.beginPath(),this.moveTo(t+h,i),2==l?(this.lineTo(r,i),this.lineTo(this.pointer.x,this.pointer.y),this.lineTo(a,i),this.lineTo(o-h,i)):this.lineTo(o-h,i),this.quadraticCurveTo(o,i,o,i+h),1==l?(this.lineTo(o,r),this.lineTo(this.pointer.x,this.pointer.y),this.lineTo(o,a),this.lineTo(o,b-h)):this.lineTo(o,b-h),this.quadraticCurveTo(o,b,o-h,b),3==l?(this.lineTo(a,b),this.lineTo(this.pointer.x,this.pointer.y),this.lineTo(r,b),this.lineTo(t+h,b)):this.lineTo(t+h,b),this.quadraticCurveTo(t,b,t,b-h),0==l?(this.lineTo(t,a),this.lineTo(this.pointer.x,this.pointer.y),this.lineTo(t,r),this.lineTo(t,i+h)):this.lineTo(t,i+h),this.quadraticCurveTo(t,i,t+h,i),this.stroke()}},{key:"setEvents",value:function(){var t=this;this.canvas.on("object:scaling",function(t){var i=t.target;!i.strokeWidthUnscaled&&i.strokeWidth&&(i.strokeWidthUnscaled=i.strokeWidth),i.strokeWidthUnscaled&&(i.strokeWidth=i.strokeWidthUnscaled/i.scaleX)}),this.bubble.on("moving",function(i){t.pointer.setVisible(!1)}),this.bubble.on("rotating",function(i){t.pointer.setVisible(!1)}),this.bubble.on("scaling",function(i){t.pointer.setVisible(!1)}),this.bubble.on("modified",function(i){t.pointer.setVisible(!0)}),this.bubble.on("selected",function(i){t.scaling(i),t.pointer.show()})}},{key:"create",value:function(){this.generatePath(),this.bubble=new fabric[this.id](this.fabricPathText),this.setEvents(),this.bubble.set({strokeWidth:this.lineWidth,fill:this.backgroundColor,stroke:this.lineColor,hasRotatingPoint:!1}),this.bubble.set(this.bordersOptions),this.show()}},{key:"update",value:function(){this.hide(),this.create()}},{key:"moving",value:function(t,i){this.x+=t.e.movementX,this.y+=t.e.movementY,this.pointer.x+=t.e.movementX,this.pointer.y+=t.e.movementY,this.pointer.update()}},{key:"scaling",value:function(t){var i;if(0==this.direction){this.pointer.x=this.bubble.oCoords.tl.x-13,i=(-this.bubble.oCoords.tl.y+this.bubble.oCoords.bl.y)/(this.fabricPathText[6][2]-this.fabricPathText[11][2]),this.pointer.y=i*(this.fabricPathText[8][2]-this.fabricPathText[11][2])+this.bubble.oCoords.tl.y-13,this.h=this.bubble.oCoords.mb.y-this.bubble.oCoords.mt.y;var s=(this.fabricPathText[3][1]-this.fabricPathText[9][1])/(this.fabricPathText[3][1]-this.fabricPathText[8][1]);this.w=(this.bubble.oCoords.mr.x-this.bubble.oCoords.ml.x)*s,this.y=this.bubble.oCoords.tl.y,this.x=this.bubble.oCoords.ml.x+(this.bubble.oCoords.mr.x-this.bubble.oCoords.ml.x)*(1-s)}if(2==this.direction){var e=(this.fabricPathText[9][2]-this.fabricPathText[11][2])/(this.fabricPathText[9][2]-this.fabricPathText[2][2]);if(this.y=this.bubble.oCoords.tl.y+(1-e)*(this.bubble.oCoords.bl.y-this.bubble.oCoords.tl.y),this.fabricPathText[2][1]>this.fabricPathText[11][1]&&this.fabricPathText[2][1]<this.fabricPathText[5][1])this.pointer.y=this.bubble.oCoords.tl.y-16,i=(-this.bubble.oCoords.tl.x+this.bubble.oCoords.tr.x)/(this.fabricPathText[5][1]-this.fabricPathText[11][1]),this.pointer.x=i*(this.fabricPathText[2][1]-this.fabricPathText[11][1])+this.bubble.oCoords.tl.x-8,this.w=this.bubble.oCoords.tr.x-this.bubble.oCoords.tl.x,this.x=this.bubble.oCoords.tl.x;else if(this.fabricPathText[2][1]<this.fabricPathText[11][1]){this.pointer.y=this.bubble.oCoords.tl.y-14,this.pointer.x=this.bubble.oCoords.tl.x-13;var h=(this.fabricPathText[5][1]-this.fabricPathText[11][1])/(this.fabricPathText[5][1]-this.fabricPathText[2][1]);this.w=(this.bubble.oCoords.tr.x-this.bubble.oCoords.tl.x)*h,this.x=this.bubble.oCoords.tl.x+(this.bubble.oCoords.tr.x-this.bubble.oCoords.tl.x)*(1-h)}else if(this.fabricPathText[2][1]>this.fabricPathText[5][1]){this.pointer.y=this.bubble.oCoords.tr.y-14,this.pointer.x=this.bubble.oCoords.tr.x-5;var o=(this.fabricPathText[5][1]-this.fabricPathText[11][1])/(this.fabricPathText[2][1]-this.fabricPathText[11][1]);this.w=(this.bubble.oCoords.tr.x-this.bubble.oCoords.tl.x)*o,this.x=this.bubble.oCoords.tl.x}this.h=(this.bubble.oCoords.bl.y-this.bubble.oCoords.tl.y)*e}if(1==this.direction){this.pointer.x=this.bubble.oCoords.tr.x,i=(-this.bubble.oCoords.tl.y+this.bubble.oCoords.bl.y)/(this.fabricPathText[7][2]-this.fabricPathText[2][2]),this.pointer.y=i*(this.fabricPathText[4][2]-this.fabricPathText[2][2])+this.bubble.oCoords.tl.y-10,this.x=this.bubble.oCoords.tl.x,this.y=this.bubble.oCoords.tl.y,this.h=this.bubble.oCoords.mb.y-this.bubble.oCoords.mt.y;var b=(this.fabricPathText[2][1]-this.fabricPathText[11][1])/(this.fabricPathText[4][1]-this.fabricPathText[11][1]);this.w=(this.bubble.oCoords.mr.x-this.bubble.oCoords.ml.x)*b}if(3==this.direction){this.pointer.y=this.bubble.oCoords.bl.y;var r=(this.fabricPathText[9][2]-this.fabricPathText[11][2])/(this.fabricPathText[6][2]-this.fabricPathText[11][2]);if(this.h=(this.bubble.oCoords.bl.y-this.bubble.oCoords.tl.y)*r,this.fabricPathText[6][1]>this.fabricPathText[9][1]&&this.fabricPathText[6][1]<this.fabricPathText[4][1])i=(-this.bubble.oCoords.bl.x+this.bubble.oCoords.br.x)/(this.fabricPathText[9][1]-this.fabricPathText[4][1]),this.pointer.x=i*(-this.fabricPathText[6][1]+this.fabricPathText[9][1])+this.bubble.oCoords.tl.x-8,this.w=this.bubble.oCoords.br.x-this.bubble.oCoords.bl.x,this.x=this.bubble.oCoords.tl.x,this.y=this.bubble.oCoords.tl.y;else if(this.fabricPathText[6][1]<this.fabricPathText[9][1]){var a=(this.fabricPathText[4][1]-this.fabricPathText[9][1])/(this.fabricPathText[4][1]-this.fabricPathText[6][1]);this.w=(this.bubble.oCoords.br.x-this.bubble.oCoords.bl.x)*a,this.pointer.y=this.bubble.oCoords.bl.y-5,this.pointer.x=this.bubble.oCoords.bl.x-13,this.x=this.bubble.oCoords.bl.x+(this.bubble.oCoords.br.x-this.bubble.oCoords.bl.x)*(1-a),this.y=this.bubble.oCoords.tl.y}else if(this.fabricPathText[6][1]>this.fabricPathText[4][1]){var n=(this.fabricPathText[4][1]-this.fabricPathText[9][1])/(this.fabricPathText[6][1]-this.fabricPathText[9][1]);this.w=(this.bubble.oCoords.br.x-this.bubble.oCoords.bl.x)*n,this.pointer.y=this.bubble.oCoords.br.y-5,this.pointer.x=this.bubble.oCoords.br.x-5,this.x=this.bubble.oCoords.tl.x,this.y=this.bubble.oCoords.tl.y}}this.pointer.update()}},{key:"show",value:function(){this.canvas.add(this.bubble)}},{key:"hide",value:function(){this.canvas.remove(this.bubble)}}]),t}(),e=function(){function t(e,h,o,b){_classCallCheck(this,t),this.id="Bubble"+Date.now(),this.canvas=h,this.pointer=new i(this.canvas,b),this.bubble=new s(this.canvas,o,this.pointer,e),this.pointer.setBubble(this.bubble),this.init()}return _createClass(t,[{key:"init",value:function(){var t=this;this.bubble.create(),this.pointer.create(),this.canvas.on("selection:cleared",function(i){t.pointer.hide()}),this.canvas.on("mouse:up",function(i){t.bubble.scaling(i),t.bubble.bubble.active?t.pointer.show():null===i.target&&t.pointer.hide()})}}]),t}();return e}();