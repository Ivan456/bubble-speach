var Bubble=function(){class a{constructor(f,g){this.id='BubblePointer'+Date.now(),this.canvas=f,this.hasControls=!1,this.x=g.x,this.y=g.y,this.radius=g.radius,this.color=g.color,this.pointer={},this.hidden=g.hidden||!0,this.innerText={},this.group={}}setBubble(f){this.bubble=f}create(){let f={radius:this.radius,fill:this.color,left:this.x,top:this.y,hasControls:this.hasControls,hasBorders:this.hasControls};this.pointer=new fabric.Circle(f),this.pointer.on('moving',g=>{this.moving(g)}),this.pointer.on('mousedown',()=>{this.setVisible(!0)})}update(){var f={left:this.x,top:this.y};this.pointer.set(f),!1===this.hidden&&(this.hide(),this.show())}show(){this.hidden&&(this.canvas.add(this.pointer),this.hidden=!1)}setVisible(f){this.pointer.visible=f}hide(){this.canvas.remove(this.pointer),this.hidden=!0}moving(f){this.x=f.e.offsetX,this.y=f.e.offsetY,this.bubble.update()}}class c{constructor(f,g,i,j){this.id='BubblePath'+Date.now(),this.canvas=f,this.pointer=i,this.x=g.x,this.y=g.y,this.w=g.w,this.h=g.h,this.radius=Math.min(g.h,g.w)/5,this.fabricPathText=[],this.bubble={},this.backgroundColor=g.backgroundColor,this.lineColor=g.lineColor,this.lineWidth=g.lineWidth,this.direction,this.bordersOptions={borderColor:'red',cornerColor:'green',cornerSize:7,transparentCorners:!1},this.extendFabricPathBubble(j)}extendFabricPathBubble(f){let g=this;f[g.id]=f.util.createClass(f.Path,{type:g.id,initialize:function(i){this.callSuper('initialize',i)},toObject:function(){return g.pointer.setVisible(!1),{type:'BubblePath',bubbleOptions:{x:g.x,y:g.y,w:g.w,h:g.h,lineWidth:g.lineWidth,lineColor:g.lineColor,backgroundColor:g.backgroundColor},pointerOptions:{x:g.pointer.x,y:g.pointer.y,radius:g.pointer.radius,color:g.pointer.color}}}}),f[g.id].async=!0}beginPath(){this.fabricPathText=[]}moveTo(f,g){this.fabricPathText.push(['M',f,g])}lineTo(f,g){this.fabricPathText.push(['L',f,g])}quadraticCurveTo(f,g,i,j){this.fabricPathText.push(['Q',f,g,i,j])}stroke(){this.fabricPathText.push(['z'])}generatePath(){let p,q,s,{x:f,y:g,w:i,h:j,radius:l}=this,m=f+i,n=g+j;l=Math.min(j,i)/4,this.pointer.y<g||this.pointer.y>g+j?(s=0.3*i,p=Math.min(Math.max(f+l,this.pointer.x-s/2),m-l-s),q=Math.min(Math.max(f+l+s,this.pointer.x+s/2),m-l)):(s=0.3*j,p=Math.min(Math.max(g+l,this.pointer.y-s/2),n-l-s),q=Math.min(Math.max(g+l+s,this.pointer.y+s/2),n-l));let t;this.pointer.y<g&&(t=this.direction=2),this.pointer.y>g&&(t=this.direction=3),this.pointer.x<f&&this.pointer.y>=g&&this.pointer.y<=n&&(t=this.direction=0),this.pointer.x>f&&this.pointer.y>=g&&this.pointer.y<=n&&(t=this.direction=1),this.pointer.x>=f&&this.pointer.x<=m&&this.pointer.y>=g&&this.pointer.y<=n&&(t=-1),this.beginPath(),this.moveTo(f+l,g),2==t?(this.lineTo(p,g),this.lineTo(this.pointer.x,this.pointer.y),this.lineTo(q,g),this.lineTo(m-l,g)):this.lineTo(m-l,g),this.quadraticCurveTo(m,g,m,g+l),1==t?(this.lineTo(m,p),this.lineTo(this.pointer.x,this.pointer.y),this.lineTo(m,q),this.lineTo(m,n-l)):this.lineTo(m,n-l),this.quadraticCurveTo(m,n,m-l,n),3==t?(this.lineTo(q,n),this.lineTo(this.pointer.x,this.pointer.y),this.lineTo(p,n),this.lineTo(f+l,n)):this.lineTo(f+l,n),this.quadraticCurveTo(f,n,f,n-l),0==t?(this.lineTo(f,q),this.lineTo(this.pointer.x,this.pointer.y),this.lineTo(f,p),this.lineTo(f,g+l)):this.lineTo(f,g+l),this.quadraticCurveTo(f,g,f+l,g),this.stroke()}setEvents(){this.canvas.on('object:scaling',f=>{var g=f.target;!g.strokeWidthUnscaled&&g.strokeWidth&&(g.strokeWidthUnscaled=g.strokeWidth),g.strokeWidthUnscaled&&(g.strokeWidth=g.strokeWidthUnscaled/g.scaleX)}),this.bubble.on('deselected',()=>{this.pointer.setVisible(!1)}),this.bubble.on('moving',()=>{this.pointer.setVisible(!1)}),this.bubble.on('rotating',()=>{this.pointer.setVisible(!1)}),this.bubble.on('scaling',()=>{this.pointer.setVisible(!1)}),this.bubble.on('modified',()=>{this.pointer.setVisible(!0)}),this.bubble.on('selected',f=>{this.pointer.setVisible(!0),this.scaling(f)})}create(){this.generatePath(),this.bubble=new fabric[this.id](this.fabricPathText),this.setEvents(),this.bubble.set({strokeWidth:this.lineWidth,fill:this.backgroundColor,stroke:this.lineColor,hasRotatingPoint:!1}),this.bubble.set(this.bordersOptions),this.show()}update(){this.hide(),this.create()}moving(f){this.x+=f.e.movementX,this.y+=f.e.movementY,this.pointer.x+=f.e.movementX,this.pointer.y+=f.e.movementY,this.pointer.update()}scaling(){var g;if(0==this.direction){this.pointer.x=this.bubble.oCoords.tl.x-13,g=(-this.bubble.oCoords.tl.y+this.bubble.oCoords.bl.y)/(this.fabricPathText[6][2]-this.fabricPathText[11][2]),this.pointer.y=g*(this.fabricPathText[8][2]-this.fabricPathText[11][2])+this.bubble.oCoords.tl.y-13,this.h=this.bubble.oCoords.mb.y-this.bubble.oCoords.mt.y;let i=(this.fabricPathText[3][1]-this.fabricPathText[9][1])/(this.fabricPathText[3][1]-this.fabricPathText[8][1]);this.w=(this.bubble.oCoords.mr.x-this.bubble.oCoords.ml.x)*i,this.y=this.bubble.oCoords.tl.y,this.x=this.bubble.oCoords.ml.x+(this.bubble.oCoords.mr.x-this.bubble.oCoords.ml.x)*(1-i)}if(2==this.direction){let i=(this.fabricPathText[9][2]-this.fabricPathText[11][2])/(this.fabricPathText[9][2]-this.fabricPathText[2][2]);if(this.y=this.bubble.oCoords.tl.y+(1-i)*(this.bubble.oCoords.bl.y-this.bubble.oCoords.tl.y),this.fabricPathText[2][1]>this.fabricPathText[11][1]&&this.fabricPathText[2][1]<this.fabricPathText[5][1])this.pointer.y=this.bubble.oCoords.tl.y-16,g=(-this.bubble.oCoords.tl.x+this.bubble.oCoords.tr.x)/(this.fabricPathText[5][1]-this.fabricPathText[11][1]),this.pointer.x=g*(this.fabricPathText[2][1]-this.fabricPathText[11][1])+this.bubble.oCoords.tl.x-8,this.w=this.bubble.oCoords.tr.x-this.bubble.oCoords.tl.x,this.x=this.bubble.oCoords.tl.x;else if(this.fabricPathText[2][1]<this.fabricPathText[11][1]){this.pointer.y=this.bubble.oCoords.tl.y-14,this.pointer.x=this.bubble.oCoords.tl.x-13;let j=(this.fabricPathText[5][1]-this.fabricPathText[11][1])/(this.fabricPathText[5][1]-this.fabricPathText[2][1]);this.w=(this.bubble.oCoords.tr.x-this.bubble.oCoords.tl.x)*j,this.x=this.bubble.oCoords.tl.x+(this.bubble.oCoords.tr.x-this.bubble.oCoords.tl.x)*(1-j)}else if(this.fabricPathText[2][1]>this.fabricPathText[5][1]){this.pointer.y=this.bubble.oCoords.tr.y-14,this.pointer.x=this.bubble.oCoords.tr.x-5;let j=(this.fabricPathText[5][1]-this.fabricPathText[11][1])/(this.fabricPathText[2][1]-this.fabricPathText[11][1]);this.w=(this.bubble.oCoords.tr.x-this.bubble.oCoords.tl.x)*j,this.x=this.bubble.oCoords.tl.x}this.h=(this.bubble.oCoords.bl.y-this.bubble.oCoords.tl.y)*i}if(1==this.direction){this.pointer.x=this.bubble.oCoords.tr.x,g=(-this.bubble.oCoords.tl.y+this.bubble.oCoords.bl.y)/(this.fabricPathText[7][2]-this.fabricPathText[2][2]),this.pointer.y=g*(this.fabricPathText[4][2]-this.fabricPathText[2][2])+this.bubble.oCoords.tl.y-10,this.x=this.bubble.oCoords.tl.x,this.y=this.bubble.oCoords.tl.y,this.h=this.bubble.oCoords.mb.y-this.bubble.oCoords.mt.y;let i=(this.fabricPathText[2][1]-this.fabricPathText[11][1])/(this.fabricPathText[4][1]-this.fabricPathText[11][1]);this.w=(this.bubble.oCoords.mr.x-this.bubble.oCoords.ml.x)*i}if(3==this.direction){this.pointer.y=this.bubble.oCoords.bl.y;let i=(this.fabricPathText[9][2]-this.fabricPathText[11][2])/(this.fabricPathText[6][2]-this.fabricPathText[11][2]);if(this.h=(this.bubble.oCoords.bl.y-this.bubble.oCoords.tl.y)*i,this.fabricPathText[6][1]>this.fabricPathText[9][1]&&this.fabricPathText[6][1]<this.fabricPathText[4][1])g=(-this.bubble.oCoords.bl.x+this.bubble.oCoords.br.x)/(this.fabricPathText[9][1]-this.fabricPathText[4][1]),this.pointer.x=g*(-this.fabricPathText[6][1]+this.fabricPathText[9][1])+this.bubble.oCoords.tl.x-8,this.w=this.bubble.oCoords.br.x-this.bubble.oCoords.bl.x,this.x=this.bubble.oCoords.tl.x,this.y=this.bubble.oCoords.tl.y;else if(this.fabricPathText[6][1]<this.fabricPathText[9][1]){let j=(this.fabricPathText[4][1]-this.fabricPathText[9][1])/(this.fabricPathText[4][1]-this.fabricPathText[6][1]);this.w=(this.bubble.oCoords.br.x-this.bubble.oCoords.bl.x)*j,this.pointer.y=this.bubble.oCoords.bl.y-5,this.pointer.x=this.bubble.oCoords.bl.x-13,this.x=this.bubble.oCoords.bl.x+(this.bubble.oCoords.br.x-this.bubble.oCoords.bl.x)*(1-j),this.y=this.bubble.oCoords.tl.y}else if(this.fabricPathText[6][1]>this.fabricPathText[4][1]){let j=(this.fabricPathText[4][1]-this.fabricPathText[9][1])/(this.fabricPathText[6][1]-this.fabricPathText[9][1]);this.w=(this.bubble.oCoords.br.x-this.bubble.oCoords.bl.x)*j,this.pointer.y=this.bubble.oCoords.br.y-5,this.pointer.x=this.bubble.oCoords.br.x-5,this.x=this.bubble.oCoords.tl.x,this.y=this.bubble.oCoords.tl.y}}this.pointer.update()}show(){this.canvas.add(this.bubble)}hide(){this.canvas.remove(this.bubble)}}return class{constructor(f,g,i,j){return this.id='Bubble'+Date.now(),this.canvas=g,this.pointer=new a(this.canvas,j),this.bubble=new c(this.canvas,i,this.pointer,f),this.pointer.setBubble(this.bubble),this.init(),this.bubble}init(){this.bubble.create(),this.pointer.create(),this.canvas.on('selection:cleared',()=>{this.pointer.hide()}),this.canvas.on('mouse:up',f=>{this.bubble.scaling(f),this.bubble.bubble.active?this.pointer.show():null===f.target&&this.pointer.hide()})}}}();function extendFabricPathBubble(a,c){a.BubblePath=a.util.createClass(a.Path,{type:'BubblePath',initialize:function(d){this.callSuper('initialize',d)}}),a.BubblePath.fromObject=function({bubbleOptions:d,pointerOptions:f},g){new Bubble(a,c,d,f);g&&g(null,new Error('error Bubble'))}}